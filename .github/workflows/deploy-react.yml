name: Deploy React App to IIS

on:
  push:
    branches:
      - "local"
      - "test"
      - "dev"

jobs:
  build:
    runs-on: self-hosted  
    strategy:
      matrix:
        environment: [local, test, dev]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.14.0'

      - name: Cache node modules
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm install

      - name: Debug Info
        run: |
          echo "Node Version:"
          node -v
          echo "NPM Version:"
          npm -v
          echo "Installed Packages:"
          npm list

      - name: Build project for ${{ matrix.environment }}
        run: |
          if [ "${{ matrix.environment }}" == "local" ]; then
            npm run build:local
          elif [ "${{ matrix.environment }}" == "test" ]; then
            npm run build:test
          elif [ "${{ matrix.environment }}" == "dev" ]; then
            npm run build:dev
          fi

      - name: Deploy to IIS
        run: |
          $envName = "${{ matrix.environment }}"
          $websiteName = "courseClient_$envName"
          $appPoolName = "courseClient_$envName"

          if ((Get-WebSiteState -Name $websiteName).Value -eq "Started") {
            Stop-WebSite -Name $websiteName
            echo "Stopped Website $websiteName"
          }
          if ((Get-WebAppPoolState -Name $appPoolName).Value -eq "Started") {
            Stop-WebAppPool -Name $appPoolName
            echo "Stopped Application Pool $appPoolName"
          }

          Start-Sleep -s 15
          Copy-Item -Path "${{ github.workspace }}\build\*" -Destination "C:\inetpub\wwwroot\$websiteName" -Recurse -Force

          if ((Get-WebSiteState -Name $websiteName).Value -eq "Stopped") {
            Start-WebSite -Name $websiteName
            echo "Started Website $websiteName"
          }
          if ((Get-WebAppPoolState -Name $appPoolName).Value -eq "Stopped") {
            Start-WebAppPool -Name $appPoolName
            echo "Started Application Pool $appPoolName"
          }

          if ($lastexitcode -lt 8) { $global:lastexitcode = 0 }
